var express = require('express');
var fs = require('fs');
var request = require('request');
var cheerio = require('cheerio');
var expressapp     = express();
var bodyParser = require('body-parser');
var exec = require('child_process').exec;
var dive = require('dive');

//Configuring middleware
expressapp.use(bodyParser())

//Maps requests to the ./public folder for static assets
expressapp.use(express.static('public'));

//Maps the assets request to the resources/js file
expressapp.use('/mock', express.static(__dirname + '/mock-responses'));





//Dynamic file system management
expressapp.get('/list', function(req, res) { //returns a list of app pages
res.setHeader('Content-Type', 'application/json');
var baseDir = '/apps/';
var childrenFolders = ['asdf'];
res.send(JSON.stringify(childrenFolders))
var divePromise = function() {
    return new Promise(function(resolve, reject) {
        dive(process.cwd() + baseDir, { recursive: false, directories: true, files: false }, function(err, dir) {
          if (err) throw err;
          childrenFolders.push(dir.split(baseDir)[1]);

    });
    resolve(console.log('asdf'));
});
}
    //
var dp = divePromise();
dp.catch(function(err){ return console.error('Error somewhere in promise',err); })
  .then(function(msg) {
        // ^^ 'msg' param is an array of returned values
    console.log('sd'); // array of resolve(msg) from above..
              // res.send(JSON.stringify(childrenFolders))

  });

    
})

expressapp.post('/copy', function(req, res) {
    //var arg = req.param('username'); //maps to the 'name' field on the input
    var target = req.param('fileName');//needs to be read via the req
    var command = 'cp -r ./public/apps/' + target + ' ./public/apps/' + target + '-clone';

    //returns a list of app pages
    exec(command,
        function (error, stdout, stderr) {
            // var list = stdout.split('\n');
            res.send('successful');
    });
})

//rename
expressapp.post('/rename', function(req, res) {
    //var arg = req.param('username'); //maps to the 'name' field on the input
    var target = req.param('filePath');//these values need to be from the req
    var newName = req.param('newName');//these values need to be from the req
    var command = 'mv ./public/apps/' + target + ' ./public/apps/' + newName;
    exec(command,
        function (error, stdout, stderr) {
            res.send('successful');
    });
})

//Sets up the listener for the express app
expressapp.listen('8081')

//Splash screen including the Node JS logo ascii art
console.log('................................................................................\n.....................................=====......................................\n..................................===========...................................\n...............................=================................................\n............................===========.===========.............................\n..........................==========.......==========...........................\n.......................===========...........===========........................\n....................===========.................===========.....................\n.................===========.......................===========..................\n...............==========.............................==========................\n............==========...................................==========.............\n.........===========.......................................===========..........\n.......==========.............................................==========........\n......========...................................................========.......\n......=====.........................................................=====.......\n......=====.........................................................=====.......\n......=====..............======........=================............=====.......\n......=====..............======......=====================..........=====.......\n......=====..............======....=========================........=====.......\n......=====..............======....======............=======........=====.......\n......=====..............======...======...............======.......=====.......\n......=====..............======...======................=====.......=====.......\n......=====..............======...========..........................=====.......\n......=====..............======....================.................=====.......\n......=====..............======.....======================..........=====.......\n......=====..............======........=====================........=====.......\n......=====..............======..............================.......=====.......\n......=====..............======........................=======......=====.......\n......=====..............======..======.................======......=====.......\n......=====..............======..======.................======......=====.......\n......=====..............======...======................======......=====.......\n......=====..............======...=========..........========.......=====.......\n......=====..............======.....========================........=====.......\n......=====..............======.......====================..........=====.......\n......=====..............======...........============..............=====.......\n......======.............======.....................................=====.......\n......========...........======..................................========.......\n.......==========........======...............................==========........\n.........===========...=======.............................===========..........\n............==================..........................===========.............\n...............==============.........................==========................\n..................========.........................==========...................\n................................................==========......................\n.............................=====...........===========........................\n...........................==========.....===========...........................\n.............................==========.==========..............................\n................................===============.................................\n...................................==========...................................\n.....................................=====......................................\n................................................................................\n');
console.log('          Node App Page Management Started at localhost:8081');

exports = module.exports = expressapp;